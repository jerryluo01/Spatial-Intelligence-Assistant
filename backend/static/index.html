<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Space Assistant Chat</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                background: #0b0c10;
                color: #fff;
                padding: 20px;
            }
            #chat {
                background: #1f2833;
                border-radius: 8px;
                padding: 15px;
                height: 60vh;
                overflow-y: auto;
                margin-bottom: 10px;
            }
            input,
            button {
                font-size: 1rem;
                padding: 8px;
            }
            input {
                width: 80%;
                border: none;
                border-radius: 5px;
            }
            button {
                background: #45a29e;
                color: #fff;
                border: none;
                border-radius: 5px;
                cursor: pointer;
            }
            button:hover {
                background: #66fcf1;
                color: #000;
            }
        </style>
    </head>
    <body>
        <h2>üõ∞Ô∏è Intelligent Space Science Assistant</h2>
        <div id="chat"></div>
        <input
            id="userInput"
            type="text"
            placeholder="Ask something about the Solar Orbiter..."
        />
        <button onclick="sendQuery()">Send</button>

        <script>
            const input = document.getElementById("userInput");
            const chat = document.getElementById("chat");

            input.addEventListener("keydown", (event) => {
                if (event.key === "Enter") {
                    event.preventDefault();
                    sendQuery();
                }
            });

            async function sendQuery() {
                const query = input.value.trim();
                if (!query) return;

                chat.innerHTML += `<p><b>You:</b> ${query}</p>`;
                input.value = "";

                try {
                    const res = await fetch(
                        "http://localhost:8000/stream_query",
                        {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ query }),
                        }
                    );

                    if (!res.ok) {
                        chat.innerHTML += `<p style="color:red;">Error: ${res.status}</p>`;
                        return;
                    }

                    const data = await res.json();

                    const formattedAnswer = data.answer
                        .replace(/\n/g, "<br>")
                        .replace(/\*\*(.*?)\*\*/g, "<b>$1</b>");

                    const formattedMatches =
                        data.matches
                            ?.map(
                                (m, i) => `
                    <div style="
                        background:#0b0c10;
                        padding:8px;
                        border-radius:6px;
                        margin-bottom:8px;
                        border:1px solid #45a29e;
                    ">
                        <b>Result ${i + 1}</b><br>
                        <b>Name:</b> ${m.name || "N/A"}<br>
                        <b>Class:</b> ${m.class_ || "N/A"}<br>
                        <b>Subsystem:</b> ${
                            m.user_props?.Subsystem || "N/A"
                        }<br>
                        <b>Weight:</b> ${m.user_props?.Weight || "N/A"}
                    </div>`
                            )
                            .join("") || "";

                    chat.innerHTML += `
                <div style="margin-top:10px; padding:10px; background:#16202a; border-radius:8px;">
                    <p><b>AI:</b><br>${formattedAnswer}</p>
                    ${
                        data.matches?.length
                            ? `<div style="
                                margin-top:10px;
                                max-height:200px;
                                overflow-y:auto;
                                overflow-x:hidden;
                            ">${formattedMatches}</div>`
                            : ""
                    }
                </div>
                <hr/>
            `;

                    chat.scrollTop = chat.scrollHeight;
                } catch (err) {
                    chat.innerHTML += `<p style="color:red;">Error: ${err.message}</p>`;
                }
            }
        </script>
    </body>
</html>
